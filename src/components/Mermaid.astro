---
export interface Props {
  title?: string;
}
const { title = "" } = Astro.props;
---

<figure class="expandable-diagram my-8">
  {title && <figcaption class="diagram-title">{title}</figcaption>}

  <div class="diagram-wrapper">
    <div class="diagram-content">
      Loading diagram...
    </div>
    
    <div class="diagram-toolbar">
      <button class="download-png-btn toolbar-btn" title="Download as PNG">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
      </button>
      <button class="toggle-source-btn toolbar-btn" title="View source code">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>
      </button>
    </div>
  </div>

  <div class="source-code-container">
    <slot />
  </div>
</figure>

<style>
  .expandable-diagram {
    position: relative;
  }

  .diagram-title {
    font-size: 0.95rem;
    font-weight: 500;
    color: var(--color-foreground, currentColor);
    margin-bottom: 0.75rem;
  }

  .diagram-wrapper {
    position: relative;
    background: hsl(var(--muted) / 0.3);
    border-radius: 0.75rem;
    overflow: hidden;
  }

  .diagram-content {
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 200px;
    padding: 1.5rem;
    overflow-x: auto;
    width: 100%;
  }

  .diagram-toolbar {
    position: absolute;
    top: 0.75rem;
    right: 0.75rem;
    display: flex;
    gap: 0.25rem;
    opacity: 0;
    transition: opacity 0.2s ease;
  }

  .diagram-wrapper:hover .diagram-toolbar {
    opacity: 1;
  }

  .toolbar-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 2rem;
    height: 2rem;
    border-radius: 0.5rem;
    background: hsl(var(--background) / 0.9);
    border: 1px solid hsl(var(--border) / 0.5);
    color: hsl(var(--muted-foreground));
    cursor: pointer;
    transition: all 0.15s ease;
    backdrop-filter: blur(4px);
  }

  .toolbar-btn:hover {
    background: hsl(var(--background));
    color: hsl(var(--foreground));
    border-color: hsl(var(--border));
    transform: translateY(-1px);
  }

  .toolbar-btn:active {
    transform: translateY(0);
  }

  .toolbar-btn.active {
    background: hsl(var(--primary) / 0.1);
    color: hsl(var(--primary));
    border-color: hsl(var(--primary) / 0.3);
  }

  .source-code-container {
    display: none;
    margin-top: 0.75rem;
    border-radius: 0.5rem;
    overflow: hidden;
  }

  .source-code-container.show {
    display: block;
  }

  .expandable-diagram :global(.mermaid) {
    width: 100% !important;
    display: flex !important;
    justify-content: center !important;
  }
  
  .expandable-diagram :global(.mermaid svg) {
    width: 100% !important;
    max-width: 900px !important;
    height: auto !important;
    min-height: 400px !important;
  }
</style>

<script>
  import mermaid from "mermaid";

  // Register the logos icon pack from Iconify (includes AWS icons like aws-s3, aws-lambda, etc.)
  // and a custom pack for icons not in Iconify (like Bedrock)
  mermaid.registerIconPacks([
    {
      name: 'logos',
      loader: () =>
        fetch('https://unpkg.com/@iconify-json/logos@1/icons.json').then((res) => res.json()),
    },
    {
      name: 'aws',
      icons: {
        prefix: "aws",
        width: 256,
        height: 256,
        icons: {
          // Amazon Bedrock - Custom icon (not in Iconify)
          // Uses AWS AI/ML turquoise color scheme
          "bedrock": {
            body: `<defs><linearGradient id="bedrock-grad" x1="0%" x2="100%" y1="100%" y2="0%"><stop offset="0%" stop-color="#055F4E"/><stop offset="100%" stop-color="#56C0A7"/></linearGradient></defs><path fill="url(#bedrock-grad)" d="M0 0h256v256H0z"/><path fill="#FFF" d="M128 48l72 41.6v83.2L128 214.4l-72-41.6V89.6L128 48zm0 16l-56 32.3v64.6l56 32.3 56-32.3v-64.6L128 64z"/><circle cx="128" cy="128" r="32" fill="#FFF"/><circle cx="128" cy="128" r="20" fill="url(#bedrock-grad)"/>`,
            width: 256,
            height: 256
          },
          // Generic User icon
          "user": {
            body: `<path fill="#232F3E" d="M0 0h256v256H0z"/><path fill="#FFF" d="M128 48a40 40 0 1 1 0 80 40 40 0 0 1 0-80zm0 16a24 24 0 1 0 0 48 24 24 0 0 0 0-48zm0 80c36.8 0 64 16 64 32v24H64v-24c0-16 27.2-32 64-32zm0 16c-28.8 0-48 11.2-48 16v8h96v-8c0-4.8-19.2-16-48-16z"/>`,
            width: 256,
            height: 256
          },
          // AWS Cloud icon
          "cloud": {
            body: `<path fill="#232F3E" d="M0 0h256v256H0z"/><path fill="#FFF" d="M196 132c22 0 40 18 40 40s-18 40-40 40H76c-28.8 0-52-23.2-52-52 0-25.6 18.4-46.8 42.8-51.2C76 76.8 100 56 128 56c33.6 0 60.8 27.2 60.8 60.8 0 2.4 0 4.8-.4 7.2 3.2-.8 6.4-1.2 9.6-1.2-.8 0 0 0-.8.4-.4.4-.4.4-.4.4l-.4.4c-.4.4-.4.4-.8.4-.4.4-.4.4-.8.4-.4.4-.4.4-.4.8-.4.4-.8.4-.8.8-.4.4-.4.4-.4.8-.4.4-.4.8-.8.8-.4.4-.4.4-.4.8 0 .4-.4.8-.4.8-.4.4-.4.4-.4.8-.4.4-.4.8-.4.8v.4c-.4.4-.4.8-.4 1.2 0 .4 0 .8-.4 1.2v1.2zm-12 64c16 0 28-12 28-28s-12-28-28-28h-4c-4.8 0-8.8-3.2-9.6-8-4-24.8-25.6-43.2-51.2-43.2-28.8 0-52 23.2-52 52 0 2.4 0 4.8.4 6.8.8 4.4-2 8.8-6.4 10-17.6 4.8-30.4 20.8-30.4 39.6 0 22.4 18.4 40.8 40.8 40.8z"/>`,
            width: 256,
            height: 256
          },
          // Database icon (for chunks)
          "database": {
            body: `<defs><linearGradient id="db-grad" x1="0%" x2="100%" y1="100%" y2="0%"><stop offset="0%" stop-color="#2E27AD"/><stop offset="100%" stop-color="#527FFF"/></linearGradient></defs><path fill="url(#db-grad)" d="M0 0h256v256H0z"/><path fill="#FFF" d="M128 40c44 0 80 14.4 80 32v112c0 17.6-36 32-80 32s-80-14.4-80-32V72c0-17.6 36-32 80-32zm0 16c-39.2 0-64 12.8-64 16s24.8 16 64 16 64-12.8 64-16-24.8-16-64-16zm-64 40v24c0 3.2 24.8 16 64 16s64-12.8 64-16V96c-12.8 8.8-36.8 16-64 16s-51.2-7.2-64-16zm0 48v24c0 3.2 24.8 16 64 16s64-12.8 64-16v-24c-12.8 8.8-36.8 16-64 16s-51.2-7.2-64-16zm0 48v24c0 3.2 24.8 16 64 16s64-12.8 64-16v-24c-12.8 8.8-36.8 16-64 16s-51.2-7.2-64-16z"/>`,
            width: 256,
            height: 256
          }
        }
      }
    }
  ]);

  mermaid.initialize({ 
    startOnLoad: false,
    flowchart: {
      useMaxWidth: false,
      htmlLabels: true,
      curve: 'basis'
    },
    sequence: {
      useMaxWidth: false,
      diagramMarginX: 50,
      diagramMarginY: 30,
      boxMargin: 10,
      boxTextMargin: 5,
      noteMargin: 10,
      messageMargin: 35,
      mirrorActors: true
    },
    themeVariables: {
      fontSize: '16px'
    }
  });

  function extractAndCleanMermaidCode() {
    const mermaidElements = document.querySelectorAll("figure.expandable-diagram");
    mermaidElements.forEach((element) => {
      let cleanedCode = "";
      
      // Extract from code element (preferred - preserves newlines correctly)
      const codeElement = element.querySelector('pre code, pre[data-language="mermaid"] code');
      if (codeElement) {
        // Try line-by-line extraction from spans
        const codeLines = codeElement.querySelectorAll(".line, .ec-line .code");
        if (codeLines.length > 0) {
          cleanedCode = Array.from(codeLines)
            .map((line) => (line as HTMLElement).textContent || "")
            .join("\n");
        } else {
          // Direct text content
          cleanedCode = codeElement.textContent || "";
        }
      }
      
      // Fallback: try data-code attribute (may have newline normalization issues)
      if (!cleanedCode.trim()) {
        const copyButton = element.querySelector("button[data-code]") as HTMLButtonElement | null;
        if (copyButton && copyButton.dataset.code) {
          cleanedCode = copyButton.dataset.code.replace(/\u007F/g, "\n");
        }
      }

      if (!cleanedCode.trim()) return;

      // Create a new pre element with the cleaned code
      const newPreElement = document.createElement("pre");
      newPreElement.className = "mermaid";
      newPreElement.textContent = cleanedCode.trim();

      // Find the diagram content container and replace content
      const diagramContentContainer = element.querySelector(".diagram-content");
      if (diagramContentContainer) {
        diagramContentContainer.innerHTML = "";
        diagramContentContainer.appendChild(newPreElement);
      }
    });
  }

  // Wait for DOM to be fully loaded
  document.addEventListener("DOMContentLoaded", async () => {
    extractAndCleanMermaidCode();
    await mermaid.run();
    setupDownloadButtons();
  });

  // Support Astro View Transitions
  document.addEventListener("astro:page-load", async () => {
    extractAndCleanMermaidCode();
    await mermaid.run();
    setupDownloadButtons();
  });

  function setupDownloadButtons() {
    const mermaidElements = document.querySelectorAll("figure.expandable-diagram");
    mermaidElements.forEach((element, index) => {
      const downloadBtn = element.querySelector(".download-png-btn");
      const toggleSourceBtn = element.querySelector(".toggle-source-btn");
      const sourceContainer = element.querySelector(".source-code-container");
      const svg = element.querySelector(".mermaid svg");
      
      if (downloadBtn && svg) {
        downloadBtn.addEventListener("click", () => downloadAsPng(svg as SVGSVGElement, `diagram-${index + 1}`));
      }

      if (toggleSourceBtn && sourceContainer) {
        toggleSourceBtn.addEventListener("click", () => {
          sourceContainer.classList.toggle("show");
          toggleSourceBtn.classList.toggle("active");
        });
      }
    });
  }

  function downloadAsPng(svgElement: SVGSVGElement, filename: string) {
    // Clone the SVG to avoid modifying the original
    const clonedSvg = svgElement.cloneNode(true) as SVGSVGElement;
    
    // Get the actual SVG dimensions from viewBox or attributes
    let width: number;
    let height: number;
    
    const viewBox = svgElement.getAttribute("viewBox");
    if (viewBox) {
      const parts = viewBox.split(/\s+|,/).map(Number);
      width = parts[2] || 800;
      height = parts[3] || 600;
    } else {
      // Fallback to SVG width/height attributes or bounding box
      width = svgElement.width?.baseVal?.value || svgElement.getBoundingClientRect().width || 800;
      height = svgElement.height?.baseVal?.value || svgElement.getBoundingClientRect().height || 600;
    }
    
    const scale = 2; // 2x for better quality
    const finalWidth = width * scale;
    const finalHeight = height * scale;
    
    // Set explicit dimensions on cloned SVG
    clonedSvg.setAttribute("width", String(finalWidth));
    clonedSvg.setAttribute("height", String(finalHeight));
    clonedSvg.setAttribute("viewBox", `0 0 ${width} ${height}`);
    
    // Remove any max-width/min-height styles that might interfere
    clonedSvg.style.maxWidth = "none";
    clonedSvg.style.minHeight = "none";
    clonedSvg.style.width = `${finalWidth}px`;
    clonedSvg.style.height = `${finalHeight}px`;
    
    // Add white background as first element
    const bgRect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
    bgRect.setAttribute("x", "0");
    bgRect.setAttribute("y", "0");
    bgRect.setAttribute("width", String(width));
    bgRect.setAttribute("height", String(height));
    bgRect.setAttribute("fill", "white");
    clonedSvg.insertBefore(bgRect, clonedSvg.firstChild);
    
    // Serialize SVG to base64 data URL (avoids tainted canvas issue)
    const serializer = new XMLSerializer();
    const svgString = serializer.serializeToString(clonedSvg);
    const base64Svg = btoa(unescape(encodeURIComponent(svgString)));
    const dataUrl = `data:image/svg+xml;base64,${base64Svg}`;
    
    // Create canvas and draw
    const canvas = document.createElement("canvas");
    canvas.width = finalWidth;
    canvas.height = finalHeight;
    const ctx = canvas.getContext("2d");
    
    const img = new Image();
    img.onload = () => {
      if (ctx) {
        ctx.fillStyle = "white";
        ctx.fillRect(0, 0, finalWidth, finalHeight);
        ctx.drawImage(img, 0, 0, finalWidth, finalHeight);
        
        // Download
        const pngUrl = canvas.toDataURL("image/png");
        const downloadLink = document.createElement("a");
        downloadLink.href = pngUrl;
        downloadLink.download = `${filename}.png`;
        document.body.appendChild(downloadLink);
        downloadLink.click();
        document.body.removeChild(downloadLink);
      }
    };
    img.src = dataUrl;
  }
</script>
